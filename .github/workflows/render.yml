name: Render movie
on:
  push:
    branches:
      - '*'
      - '!main'
permissions:
  contents: read
jobs:
  render_hq:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install apt dependencies
        run: |
          sudo apt-get update
          sudo apt-get install libcairo2-dev libjpeg8-dev libpango1.0-dev libgif-dev build-essential g++ ffmpeg texlive-latex-extra --fix-missing
      - name: Install fonts
        run: |
          mkdir -p ~/texmf
          for i in {1..5}; do
            curl -L -o ~/texmf/mnsymbol.zip https://mirrors.ctan.org/fonts/mnsymbol.zip && break || sleep 15
          done
          unzip ~/texmf/mnsymbol.zip -d ~/texmf
          cd ~/texmf/mnsymbol/tex && latex MnSymbol.ins
          mkdir -p ~/texmf/tex/latex/MnSymbol/
          cp ~/texmf/mnsymbol/tex/MnSymbol.sty ~/texmf/tex/latex/MnSymbol/
          mkdir -p ~/texmf/fonts/tfm/public/MnSymbol
          cp ~/texmf/mnsymbol/tfm/* ~/texmf/fonts/tfm/public/MnSymbol
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install pip dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install manim
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Render movie (manim)
        run: |
          python -m manim -v WARNING --disable_caching zkmarek/video/main.py
      - name: Verify output directory
        run: |
          echo "Contents of output directory:"
          ls -R media/videos/
      - uses: actions/upload-artifact@v3
        with:
          name: Movie HQ
          path: media/videos/**/EllipticCurves.mp4
          retention-days: 5
